<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <!-- Usamos el fragmento de head estándar para consistencia -->
    <div th:replace="~{fragments/header :: head(pageTitle=${pageTitle})}"></div>
</head>

<body class="d-flex flex-column min-vh-100 bg-dark text-white">
    <!-- Navbar estándar -->
    <div th:replace="~{fragments/header :: header}"></div>

    <main class="container my-5 flex-grow-1">
        <!-- Cabecera del panel con el botón para añadir nuevos productos -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Mi Tienda</h1>
            <a th:href="@{/panel-vendedor/ventas}" class="btn btn-info text-white me-2">Gestionar Mis Ventas</a>
            <a th:href="@{/panel-vendedor/productos/nuevo}" class="btn btn-primary text-white">+ Añadir Nuevo
                Producto</a>
        </div>

        <!-- Mensajes de éxito o error que vienen de las redirecciones -->
        <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>

        <!-- Mensaje para cuando el vendedor aún no tiene productos -->
        <div th:if="${#lists.isEmpty(productos)}" class="text-center p-5 bg-secondary-subtle text-dark rounded">
            <h3>Todavía no tienes productos a la venta.</h3>
            <p>¡Añade tu primer producto para empezar a vender!</p>
        </div>

        <!-- Tabla que se muestra solo si hay productos -->
        <div th:unless="${#lists.isEmpty(productos)}" class="table-responsive">
            <table class="table table-dark table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th style="width: 10%;">Imagen</th>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th style="width: 15%;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="p : ${productos}">
                        <td>
                            <!-- Imagen del producto con la lógica de fallback -->
                            <img th:if="${#strings.isEmpty(p.imagenUrl)}" th:src="@{/img/default.webp}" alt="Imagen por defecto" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                            <img th:unless="${#strings.isEmpty(p.imagenUrl)}" th:src="${p.imagenUrl}" th:alt="${p.nombre}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                        </td>
                        <td th:text="${p.nombre}">Nombre Producto</td>
                        <td th:text="'€' + ${#numbers.formatDecimal(p.precio, 1, 2)}">€0.00</td>
                        <td>
                            <!--
                              CONTENEDOR DE ACCIONES
                            -->
                            <div class="d-flex flex-wrap gap-2">
                                <!-- 
                                  1. ENLACE PARA EDITAR
                                  Esto es un simple enlace (GET) que lleva al formulario de edición,
                                  pasando el ID del producto en la URL.
                                -->
                                <a th:href="@{/panel-vendedor/productos/editar/{id}(id=${p.id})}" class="btn btn-sm btn-outline-light">
                                    <i class="bi bi-pencil-fill"></i> Editar
                                </a>

                                <!-- 
                                  2. FORMULARIO PARA ELIMINAR
                                  La eliminación debe ser una petición POST, por lo tanto,
                                  necesita su propio formulario.
                                -->
                                <form th:action="@{/panel-vendedor/productos/eliminar/{id}(id=${p.id})}" method="post"
                                      onsubmit="return confirm('¿Estás seguro de que quieres eliminar este producto? Esta acción no se puede deshacer.');">
                                    
                                    <!-- Token CSRF, crucial para la seguridad en peticiones POST -->
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash-fill"></i> Eliminar
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Footer y Scripts estándar -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    <div th:replace="~{fragments/scripts :: scripts}"></div>
</body>
</html>