<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{fragments/header :: head(pageTitle='Mis Pedidos')}"></div>
</head>

<body class="d-flex flex-column min-vh-100 bg-dark text-white">

    <div th:replace="~{fragments/header :: header}"></div>
    <div th:replace="~{fragments/cart-offcanvas :: cartOffcanvas}"></div>

    <main class="container my-5 flex-grow-1">
        <h1 class="mb-4">Mis Pedidos</h1>

        <!-- Mensaje para cuando no hay pedidos -->
        <div th:if="${#lists.isEmpty(pedidos)}" class="text-center p-5 bg-secondary-subtle rounded text-dark">
            <h3 class="mb-3">Aún no tienes pedidos</h3>
            <p class="lead">Todos los pedidos que realices aparecerán aquí.</p>
            <a th:href="@{/}" class="btn btn-primary mt-3">Explorar la tienda</a>
        </div>

        <!-- Acordeón que se muestra si hay pedidos -->
        <div th:unless="${#lists.isEmpty(pedidos)}" class="accordion" id="accordionPedidos">
            <div th:each="pedido, iterStat : ${pedidos}" class="accordion-item bg-dark border-secondary">
                
                <!-- Cabecera del Acordeón (no cambia, muestra info general del pedido) -->
                <h2 class="accordion-header" th:id="'heading' + ${iterStat.count}">
                    <button class="accordion-button bg-secondary-subtle text-dark collapsed" type="button" data-bs-toggle="collapse" th:data-bs-target="'#collapse' + ${iterStat.count}">
                        <div class="d-flex w-100 justify-content-between align-items-center pe-3 flex-wrap">
                            <span class="fw-bold me-3">Pedido #[<span th:text="${pedido.id}"></span>]</span>
                            <span class="me-3" th:text="${#temporals.format(pedido.fechaCreacion, 'dd-MM-yyyy')}">Fecha</span>
                            <!-- El badge ahora es más inteligente para el estado del pedido físico -->
                            <span class="badge me-3" 
                                  th:classappend="${pedido.estado == 'COMPLETADO' or pedido.estado == 'ENVIADO'} ? 'bg-success' : 'bg-warning'" 
                                  th:text="${pedido.estado == 'PENDIENTE_ENVIO'} ? 'Pendiente de Envío' : ${pedido.estado}">Estado</span>
                            <span class="fw-bold" th:text="'Total: €' + ${#numbers.formatDecimal(pedido.total, 1, 2)}">Total</span>
                        </div>
                    </button>
                </h2>

                <!-- Cuerpo del Acordeón -->
                <div th:id="'collapse' + ${iterStat.count}" class="accordion-collapse collapse" data-bs-parent="#accordionPedidos">
                    <div class="accordion-body text-white bg-secondary">
                        <h6 class="border-bottom border-secondary pb-2 mb-3">Detalles del Pedido</h6>
                        
                        <div th:each="detalle : ${pedido.detalles}">

                            <!-- ===== BLOQUE 1: Se muestra SOLO SI ES UN PRODUCTO DIGITAL ===== -->
                            <th:block th:if="${detalle.productoDigital != null}">
                                <div class="d-flex flex-column flex-md-row align-items-md-center mb-3 border-bottom border-secondary pb-3">
                                    <!-- Imagen -->
                                    <div class="me-md-3 align-self-center mb-2 mb-md-0">
                                        <img th:if="${#strings.isEmpty(detalle.productoDigital.imagenUrl)}" th:src="@{/img/default.webp}" alt="Imagen por defecto" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                                        <img th:unless="${#strings.isEmpty(detalle.productoDigital.imagenUrl)}" th:src="${detalle.productoDigital.imagenUrl}" th:alt="${detalle.productoDigital.nombre}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                                    </div>
                                    <!-- Nombre y Precio -->
                                    <div class="flex-grow-1 my-2 my-md-0 text-center text-md-start">
                                        <p class="mb-0 fw-bold" th:text="${detalle.productoDigital.nombre}"></p>
                                        <small class="text-white" th:text="'Precio: €' + ${#numbers.formatDecimal(detalle.precioUnitario, 1, 2)}"></small>
                                    </div>
                                    <!-- Clave de Activación -->
                                    <div class="ms-md-auto text-center text-md-end mt-2 mt-md-0">
                                        <p class="mb-1 small text-muted">Tu Clave de Activación:</p>
                                        <th:block th:if="${detalle.claveDigital != null}">
                                            <code class="fs-5 p-2 bg-light text-dark rounded user-select-all" th:text="${detalle.claveDigital.clave}"></code>
                                        </th:block>
                                        <th:block th:if="${detalle.claveDigital == null}">
                                            <span class="text-danger">Clave no asignada</span>
                                        </th:block>
                                    </div>
                                </div>
                            </th:block>

                            <!-- ===== BLOQUE 2: Se muestra SOLO SI ES UN PRODUCTO FÍSICO ===== -->
                            <th:block th:if="${detalle.productoFisico != null}">
                                <div class="d-flex flex-column flex-md-row align-items-md-center mb-3 border-bottom border-secondary pb-3">
                                    <!-- Imagen -->
                                    <div class="me-md-3 align-self-center mb-2 mb-md-0">
                                        <img th:if="${#strings.isEmpty(detalle.productoFisico.imagenUrl)}" th:src="@{/img/default.webp}" alt="Imagen por defecto" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                                        <img th:unless="${#strings.isEmpty(detalle.productoFisico.imagenUrl)}" th:src="${detalle.productoFisico.imagenUrl}" th:alt="${detalle.productoFisico.nombre}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                                    </div>
                                    <!-- Nombre y Precio -->
                                    <div class="flex-grow-1 my-2 my-md-0 text-center text-md-start">
                                        <p class="mb-0 fw-bold" th:text="${detalle.productoFisico.nombre}"></p>
                                        <small class="text-white" th:text="'Precio: €' + ${#numbers.formatDecimal(detalle.precioUnitario, 1, 2)}"></small>
                                    </div>
                                    <!-- Información del Envío -->
                                    <div class="ms-md-auto text-center text-md-end mt-2 mt-md-0">
                                        <p class="mb-1 small text-white">Vendido por: <strong th:text="${detalle.productoFisico.vendedor.nombre}"></strong></p>
                                        <p class="mb-1">Estado del Envío: 
                                            <span class="badge" th:classappend="${pedido.estado == 'ENVIADO'} ? 'bg-success' : 'bg-warning'" th:text="${pedido.estado == 'PENDIENTE_ENVIO'} ? 'Pendiente' : 'Enviado'"></span>
                                        </p>
                                    </div>
                                </div>
                            </th:block>
                        </div>
                        <!-- ==============================================================
                                      FIN DE LA LÓGICA MODIFICADA
                        ============================================================== -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
    <div th:replace="~{fragments/scripts :: scripts}"></div>
</body>
</html>